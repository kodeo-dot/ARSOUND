{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/lib/supabase/server-client.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createServerClient() {\n  const cookieStore = await cookies()\n\n  return createSupabaseServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Ignore cookie set errors in Server Components\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAA0B,sUAAoF;QACnH,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,gDAAgD;gBAClD;YACF;QACF;IACF;AACF","debugId":null}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/app/api/packs/%5Bid%5D/download/route.ts"],"sourcesContent":["import { createServerClient } from \"@/lib/supabase/server-client\"\nimport { NextResponse } from \"next/server\"\n\nexport async function GET(\n  request: Request,\n  context: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id: packId } = await context.params\n    const supabase = await createServerClient()\n\n    console.log(\"[v0] Download request for pack:\", packId)\n\n    // Get authenticated user\n    const {\n      data: { user },\n      error: userError,\n    } = await supabase.auth.getUser()\n\n    if (userError || !user) {\n      console.error(\"[v0] User not authenticated:\", userError)\n      return NextResponse.json(\n        { error: \"Necesitás iniciar sesión para descargar este pack\" },\n        { status: 401 }\n      )\n    }\n\n    console.log(\"[v0] User authenticated:\", user.id)\n\n    // Get pack details\n    const { data: pack, error: packError } = await supabase\n      .from(\"packs\")\n      .select(\"id, title, price, file_url, user_id\")\n      .eq(\"id\", packId)\n      .single()\n\n    if (packError || !pack) {\n      console.error(\"[v0] Pack not found:\", packError)\n      return NextResponse.json({ error: \"Pack no encontrado\" }, { status: 404 })\n    }\n\n    console.log(\"[v0] Pack found:\", { id: pack.id, price: pack.price, title: pack.title })\n\n    const isFree = !pack.price || pack.price === 0\n\n    // Check permissions for paid packs\n    if (!isFree) {\n      const { data: purchase } = await supabase\n        .from(\"purchases\")\n        .select(\"id\")\n        .eq(\"pack_id\", packId)\n        .eq(\"buyer_id\", user.id)\n        .eq(\"status\", \"completed\")\n        .single()\n\n      if (!purchase) {\n        console.log(\"[v0] User has not purchased this pack\")\n        return NextResponse.json(\n          { error: \"Necesitás comprar este pack para descargarlo\" },\n          { status: 403 }\n        )\n      }\n      console.log(\"[v0] User has purchased pack\")\n    } else {\n      const { data: limits } = await supabase.rpc(\"get_download_limit\", {\n        p_user_id: user.id,\n      })\n\n      console.log(\"[v0] Download limits:\", limits)\n\n      if (limits && limits.limit !== \"unlimited\" && limits.remaining <= 0) {\n        return NextResponse.json(\n          {\n            error: \"Alcanzaste el límite de descargas gratuitas este mes\",\n            current: limits.used,\n            limit: limits.limit,\n          },\n          { status: 403 }\n        )\n      }\n    }\n\n    // Extract file path from URL\n    const url = new URL(pack.file_url)\n    const cleanPath = url.pathname.split(\"/samplepacks/\")[1]\n\n    console.log(\"[v0] Downloading file from path:\", cleanPath)\n\n    // Download file from storage\n    const { data: fileData, error: downloadError } = await supabase.storage\n      .from(\"samplepacks\")\n      .download(cleanPath)\n\n    if (downloadError || !fileData) {\n      console.error(\"[v0] Error downloading file:\", downloadError)\n      return NextResponse.json(\n        { error: \"Error al descargar el archivo\" },\n        { status: 500 }\n      )\n    }\n\n    console.log(\"[v0] File downloaded successfully\")\n\n    const { error: recordError } = await supabase\n      .from(\"pack_downloads\")\n      .insert({\n        user_id: user.id,\n        pack_id: packId,\n        downloaded_at: new Date().toISOString(),\n      })\n\n    if (recordError) {\n      console.error(\"[v0] Error recording download:\", recordError)\n    } else {\n      console.log(\"[v0] Download recorded successfully\")\n    }\n\n    const { error: incrementError } = await supabase.rpc(\"increment\", {\n      table_name: \"packs\",\n      row_id: packId,\n      column_name: \"downloads_count\",\n    })\n\n    if (incrementError) {\n      console.error(\"[v0] Error incrementing download counter:\", incrementError)\n    } else {\n      console.log(\"[v0] Download counter incremented\")\n    }\n\n    // Return file\n    const buffer = await fileData.arrayBuffer()\n    return new NextResponse(buffer, {\n      status: 200,\n      headers: {\n        \"Content-Type\": \"application/zip\",\n        \"Content-Disposition\": `attachment; filename=\"${pack.title\n          .replace(/[^a-zA-Z0-9]/g, \"_\")\n          .replace(/_+/g, \"_\")}.zip\"`,\n      },\n    })\n  } catch (error) {\n    console.error(\"[v0] Download error:\", error)\n    return NextResponse.json(\n      { error: \"Error al procesar la descarga\" },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}