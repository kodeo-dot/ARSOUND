{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/app/plans/actions.ts"],"sourcesContent":["\"use server\"\n\nimport { createServerClient } from \"@/lib/supabase/server-client\"\nimport { PLAN_FEATURES, type PlanType } from \"@/lib/plans\"\nimport { headers } from \"next/headers\"\n\n/**\n * Helper to get the origin URL dynamically from request headers\n */\nasync function getOrigin(): Promise<string> {\n  const headersList = await headers()\n  const host = headersList.get(\"host\") || \"localhost:3000\"\n  const protocol = headersList.get(\"x-forwarded-proto\") || \"http\"\n  return `${protocol}://${host}`\n}\n\n/**\n * Server action to create Mercado Pago preference for plan selection\n * Now fully on server - no fetch call needed\n */\nasync function createMercadoPagoPreference(planType: string) {\n  const accessToken = process.env.MERCADO_PAGO_ACCESS_TOKEN\n  const publicKey = process.env.MERCADO_PAGO_PUBLIC_KEY\n\n  if (!accessToken || !publicKey) {\n    console.error(\"[v0] Mercado Pago credentials not configured\")\n    return { success: false, message: \"Error al configurar el pago. Contacta con soporte.\" }\n  }\n\n  const supabase = await createServerClient()\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    return { success: false, message: \"Por favor inicia sesión para continuar\" }\n  }\n\n  try {\n    const planPrices: Record<string, number> = {\n      de_0_a_hit: 5000,\n      de_0_a_hit_monthly: 5000,\n      studio_plus: 15000,\n      studio_plus_monthly: 15000,\n    }\n\n    const price = planPrices[planType]\n    if (!price) {\n      return { success: false, message: \"Plan inválido\" }\n    }\n\n    const origin = await getOrigin()\n\n    const preferenceData = {\n      back_urls: {\n        success: `${origin}/payment/success`,\n        failure: `${origin}/payment/failure`,\n        pending: `${origin}/payment/pending`,\n      },\n      notification_url: `${origin}/api/webhooks/mercadopago`,\n      auto_return: \"approved\" as const,\n      payer: {\n        email: user.email,\n      },\n      items: [\n        {\n          id: planType,\n          title: `Plan ARSOUND - ${planType.includes(\"de_0\") ? \"De 0 a Hit\" : \"Studio Plus\"}`,\n          quantity: 1,\n          unit_price: price,\n          currency_id: \"ARS\",\n        },\n      ],\n      external_reference: `plan_${user.id}_${planType}`,\n      metadata: {\n        type: \"plan_subscription\",\n        plan_type: planType,\n        user_id: user.id,\n      },\n    }\n\n    const response = await fetch(\"https://api.mercadopago.com/checkout/preferences\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${accessToken}`,\n      },\n      body: JSON.stringify(preferenceData),\n    })\n\n    if (!response.ok) {\n      const errorData = await response.json()\n      console.error(\"[v0] Mercado Pago API error:\", errorData)\n      return { success: false, message: \"Error al crear la preferencia de pago. Revisá las credenciales.\" }\n    }\n\n    const preference = await response.json()\n\n    if (!preference.init_point) {\n      console.error(\"[v0] Mercado Pago response missing init_point:\", preference)\n      return { success: false, message: \"Error al procesar el pago. Intenta de nuevo.\" }\n    }\n\n    return { success: true, init_point: preference.init_point, preferenceId: preference.id }\n  } catch (error) {\n    console.error(\"[v0] Error in createMercadoPagoPreference:\", error)\n    return { success: false, message: \"Error al crear la preferencia de pago\" }\n  }\n}\n\n/**\n * Server action to handle plan selection\n * Creates a Mercado Pago preference and returns checkout URL\n */\nexport async function selectPlan(planId: string) {\n  if (!planId || planId === \"free\") {\n    return { success: false, message: \"Plan inválido\" }\n  }\n\n  return createMercadoPagoPreference(planId)\n}\n\n/**\n * Server action to purchase a pack\n * Creates a Mercado Pago preference for pack purchase\n */\nexport async function purchasePack(packId: string, discountCode?: string) {\n  const supabase = await createServerClient()\n\n  const {\n    data: { user },\n  } = await supabase.auth.getUser()\n\n  if (!user) {\n    return { success: false, message: \"Por favor inicia sesión para continuar\" }\n  }\n\n  const accessToken = process.env.MERCADO_PAGO_ACCESS_TOKEN\n  const publicKey = process.env.MERCADO_PAGO_PUBLIC_KEY\n\n  if (!accessToken || !publicKey) {\n    console.error(\"[v0] Mercado Pago credentials not configured\")\n    return { success: false, message: \"Error al configurar el pago. Contacta con soporte.\" }\n  }\n\n  try {\n    const { data: pack, error: packError } = await supabase\n      .from(\"packs\")\n      .select(\"id, title, price, user_id, discount_percent, has_discount\")\n      .eq(\"id\", packId)\n      .single()\n\n    if (packError || !pack) {\n      return { success: false, message: \"Pack no encontrado\" }\n    }\n\n    const { data: sellerProfile, error: sellerError } = await supabase\n      .from(\"profiles\")\n      .select(\"plan\")\n      .eq(\"id\", pack.user_id)\n      .single()\n\n    if (sellerError || !sellerProfile) {\n      return { success: false, message: \"No se pudo obtener información del vendedor\" }\n    }\n\n    const sellerPlan = (sellerProfile.plan as PlanType) || \"free\"\n    const commission = PLAN_FEATURES[sellerPlan].commission\n\n    let finalPrice = pack.price\n    if (pack.has_discount && pack.discount_percent) {\n      finalPrice = Math.floor(pack.price * (1 - pack.discount_percent / 100))\n    }\n\n    const commissionAmount = Math.floor(finalPrice * commission)\n    const sellerEarnings = finalPrice - commissionAmount\n\n    const origin = await getOrigin()\n\n    const preferenceData = {\n      back_urls: {\n        success: `${origin}/payment/success`,\n        failure: `${origin}/payment/failure`,\n        pending: `${origin}/payment/pending`,\n      },\n      notification_url: `${origin}/api/webhooks/mercadopago`,\n      auto_return: \"approved\" as const,\n      payer: {\n        email: user.email,\n      },\n      items: [\n        {\n          id: pack.id,\n          title: pack.title,\n          quantity: 1,\n          unit_price: finalPrice,\n          currency_id: \"ARS\",\n        },\n      ],\n      external_reference: `pack_${user.id}_${packId}`,\n      marketplace_fee: commissionAmount,\n      transfer_data: {\n        amount: sellerEarnings,\n        receiver_account_id: null,\n      },\n      metadata: {\n        type: \"pack_purchase\",\n        pack_id: packId,\n        buyer_id: user.id,\n        seller_id: pack.user_id,\n        seller_plan: sellerPlan,\n        commission_percent: commission,\n        commission_amount: commissionAmount,\n        seller_earnings: sellerEarnings,\n        final_price: finalPrice,\n        discount_percent: pack.has_discount ? pack.discount_percent : 0,\n      },\n    }\n\n    const response = await fetch(\"https://api.mercadopago.com/checkout/preferences\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${accessToken}`,\n      },\n      body: JSON.stringify(preferenceData),\n    })\n\n    if (!response.ok) {\n      const errorData = await response.json()\n      console.error(\"[v0] Mercado Pago API error:\", errorData)\n      return { success: false, message: \"Error al crear la preferencia de pago. Intenta de nuevo.\" }\n    }\n\n    const preference = await response.json()\n\n    if (!preference.init_point) {\n      console.error(\"[v0] No init_point in response:\", preference)\n      return { success: false, message: \"Error al procesar el pago. Intenta de nuevo.\" }\n    }\n\n    return { success: true, init_point: preference.init_point, preferenceId: preference.id }\n  } catch (error) {\n    console.error(\"[v0] Error in purchasePack:\", error)\n    return { success: false, message: \"Error al crear la preferencia de pago\" }\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 273, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/.next-internal/server/app/plans/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {selectPlan as '40be870f8359042ca77e28750b5f416e2aa76019f9'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}}]
}