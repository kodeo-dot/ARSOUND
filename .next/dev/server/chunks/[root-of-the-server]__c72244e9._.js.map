{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/lib/supabase/server-client.ts"],"sourcesContent":["import { createServerClient as createSupabaseServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createServerClient() {\n  const cookieStore = await cookies()\n\n  return createSupabaseServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => cookieStore.set(name, value, options))\n        } catch {\n          // Ignore cookie set errors in Server Components\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAA0B,sUAAoF;QACnH,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE,GAAK,YAAY,GAAG,CAAC,MAAM,OAAO;gBAClF,EAAE,OAAM;gBACN,gDAAgD;gBAClD;YACF;QACF;IACF;AACF","debugId":null}},
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/lib/plans-actions.ts"],"sourcesContent":["\"use server\"\n\nimport { createServerClient } from \"@/lib/supabase/server-client\"\nimport type { PlanType } from \"./plans\"\n\n/**\n * Server action to update a user's subscription plan\n *\n * @param userId - The user's UUID\n * @param planType - The plan type: 'free', 'de_0_a_hit', or 'studio_plus'\n * @param expiresAt - Optional expiration date for the plan (null = no expiration)\n *\n * Usage example:\n * await updateUserPlan(userId, 'de_0_a_hit', new Date('2025-12-31'))\n *\n * NOTE: For future payment integration with Stripe/MercadoPago:\n * 1. Call this function after successful payment webhook\n * 2. Set expiresAt to the subscription end date\n * 3. For free plan, set expiresAt to null\n */\nexport async function updateUserPlan(\n  userId: string,\n  planType: PlanType,\n  expiresAt?: Date | null,\n): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createServerClient()\n\n    // Deactivate all existing plans for this user\n    const { error: deactivateError } = await supabase\n      .from(\"user_plans\")\n      .update({ is_active: false })\n      .eq(\"user_id\", userId)\n\n    if (deactivateError) {\n      console.error(\"[v0] Error deactivating plans:\", deactivateError)\n      return { success: false, error: deactivateError.message }\n    }\n\n    // Insert new plan\n    const { error: insertError } = await supabase.from(\"user_plans\").insert({\n      user_id: userId,\n      plan_type: planType,\n      is_active: true,\n      started_at: new Date().toISOString(),\n      expires_at: expiresAt ? expiresAt.toISOString() : null,\n    })\n\n    if (insertError) {\n      console.error(\"[v0] Error inserting new plan:\", insertError)\n      return { success: false, error: insertError.message }\n    }\n\n    return { success: true }\n  } catch (error: any) {\n    console.error(\"[v0] Error updating user plan:\", error)\n    return { success: false, error: error.message || \"Unknown error\" }\n  }\n}\n\n/**\n * Server action to get a user's current active plan\n *\n * @param userId - The user's UUID\n * @returns The user's current plan type\n */\nexport async function getUserPlan(userId: string): Promise<{ plan: PlanType; error?: string }> {\n  try {\n    const supabase = await createServerClient()\n\n    const { data, error } = await supabase.rpc(\"get_user_plan\", { p_user_id: userId })\n\n    if (error) {\n      console.error(\"[v0] Error fetching user plan:\", error)\n      return { plan: \"free\", error: error.message }\n    }\n\n    return { plan: (data?.plan_type as PlanType) || \"free\" }\n  } catch (error: any) {\n    console.error(\"[v0] Error getting user plan:\", error)\n    return { plan: \"free\", error: error.message || \"Unknown error\" }\n  }\n}\n\n/**\n * Server action to manually test plan changes (for development/testing)\n *\n * Usage in browser console or test script:\n * ```\n * import { testChangePlan } from '@/lib/plans-actions'\n * await testChangePlan('de_0_a_hit') // Changes current user's plan\n * ```\n */\nexport async function testChangePlan(planType: PlanType): Promise<{ success: boolean; error?: string }> {\n  try {\n    const supabase = await createServerClient()\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return { success: false, error: \"No authenticated user\" }\n    }\n\n    return await updateUserPlan(user.id, planType, null)\n  } catch (error: any) {\n    return { success: false, error: error.message || \"Unknown error\" }\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;AAEA;;;;AAkBO,eAAe,eACpB,MAAc,EACd,QAAkB,EAClB,SAAuB;IAEvB,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2JAAkB;QAEzC,8CAA8C;QAC9C,MAAM,EAAE,OAAO,eAAe,EAAE,GAAG,MAAM,SACtC,IAAI,CAAC,cACL,MAAM,CAAC;YAAE,WAAW;QAAM,GAC1B,EAAE,CAAC,WAAW;QAEjB,IAAI,iBAAiB;YACnB,QAAQ,KAAK,CAAC,kCAAkC;YAChD,OAAO;gBAAE,SAAS;gBAAO,OAAO,gBAAgB,OAAO;YAAC;QAC1D;QAEA,kBAAkB;QAClB,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,cAAc,MAAM,CAAC;YACtE,SAAS;YACT,WAAW;YACX,WAAW;YACX,YAAY,IAAI,OAAO,WAAW;YAClC,YAAY,YAAY,UAAU,WAAW,KAAK;QACpD;QAEA,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,kCAAkC;YAChD,OAAO;gBAAE,SAAS;gBAAO,OAAO,YAAY,OAAO;YAAC;QACtD;QAEA,OAAO;YAAE,SAAS;QAAK;IACzB,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO,IAAI;QAAgB;IACnE;AACF;AAQO,eAAe,YAAY,MAAc;IAC9C,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2JAAkB;QAEzC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,GAAG,CAAC,iBAAiB;YAAE,WAAW;QAAO;QAEhF,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,kCAAkC;YAChD,OAAO;gBAAE,MAAM;gBAAQ,OAAO,MAAM,OAAO;YAAC;QAC9C;QAEA,OAAO;YAAE,MAAM,AAAC,MAAM,aAA0B;QAAO;IACzD,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,iCAAiC;QAC/C,OAAO;YAAE,MAAM;YAAQ,OAAO,MAAM,OAAO,IAAI;QAAgB;IACjE;AACF;AAWO,eAAe,eAAe,QAAkB;IACrD,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2JAAkB;QAEzC,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;QAE/B,IAAI,CAAC,MAAM;YACT,OAAO;gBAAE,SAAS;gBAAO,OAAO;YAAwB;QAC1D;QAEA,OAAO,MAAM,eAAe,KAAK,EAAE,EAAE,UAAU;IACjD,EAAE,OAAO,OAAY;QACnB,OAAO;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO,IAAI;QAAgB;IACnE;AACF;;;IAzFsB;IA8CA;IA2BA;;AAzEA,iPAAA;AA8CA,iPAAA;AA2BA,iPAAA","debugId":null}},
    {"offset": {"line": 184, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/lib/plans.ts"],"sourcesContent":["export type PlanType = \"free\" | \"de_0_a_hit\" | \"studio_plus\"\n\nexport interface PlanBadge {\n  icon: string\n  label: string\n  color: string\n}\n\nexport interface PlanFeatures {\n  maxPacksPerMonth: number | null // null = unlimited\n  maxTotalPacks: number | null // null = unlimited\n  maxPrice: number | null // null = no limit\n  maxFileSize: number // in MB\n  commission: number // percentage (0.15 = 15%, 0.10 = 10%, 0.03 = 3%)\n  canUseDiscountCodes: boolean\n  canAccessFullStats: boolean\n  featuredPriority: number\n  canEditAfterDays: number | null // null = always can edit\n  canPinPack: boolean\n  canAddExternalLinks: boolean\n  maxFreeDownloads: number | null // null = unlimited\n  maxDiscountPercent: number // max discount percentage allowed\n}\n\nexport const PLAN_FEATURES: Record<PlanType, PlanFeatures> = {\n  free: {\n    maxPacksPerMonth: null,\n    maxTotalPacks: 3,\n    maxPrice: 15000, // ARS\n    maxFileSize: 80, // MB\n    commission: 0.15, // Updated from 0.10 to 0.15 (15%)\n    canUseDiscountCodes: false,\n    canAccessFullStats: false,\n    featuredPriority: 0,\n    canEditAfterDays: 15,\n    canPinPack: false,\n    canAddExternalLinks: false,\n    maxFreeDownloads: 10, // Free users can download 10 free packs per month\n    maxDiscountPercent: 10,\n  },\n  de_0_a_hit: {\n    maxPacksPerMonth: 10,\n    maxTotalPacks: null,\n    maxPrice: 65000, // ARS\n    maxFileSize: 250, // MB\n    commission: 0.1, // Updated from 0.05 to 0.10 (10%)\n    canUseDiscountCodes: true,\n    canAccessFullStats: true,\n    featuredPriority: 1,\n    canEditAfterDays: null,\n    canPinPack: false,\n    canAddExternalLinks: false,\n    maxFreeDownloads: null, // Unlimited downloads for paid plans\n    maxDiscountPercent: 50,\n  },\n  studio_plus: {\n    maxPacksPerMonth: null,\n    maxTotalPacks: null,\n    maxPrice: null, // no limit\n    maxFileSize: 500, // MB\n    commission: 0.03, // Updated from 0 to 0.03 (3%)\n    canUseDiscountCodes: true,\n    canAccessFullStats: true,\n    featuredPriority: 2,\n    canEditAfterDays: null,\n    canPinPack: true,\n    canAddExternalLinks: true,\n    maxFreeDownloads: null, // Unlimited downloads for paid plans\n    maxDiscountPercent: 100,\n  },\n}\n\nexport const PLAN_BADGES: Record<PlanType, PlanBadge | null> = {\n  free: null,\n  de_0_a_hit: {\n    icon: \"丘멮",\n    label: \"De 0 a Hit\",\n    color: \"text-orange-500\",\n  },\n  studio_plus: {\n    icon: \"游녬\",\n    label: \"Studio Plus\",\n    color: \"text-purple-500\",\n  },\n}\n\nexport function getPlanBadge(planType: PlanType): PlanBadge | null {\n  return PLAN_BADGES[planType]\n}\n\nexport function hasPlanBadge(planType: PlanType): boolean {\n  return PLAN_BADGES[planType] !== null\n}\n\nexport function getMaxDiscountPercent(planType: PlanType): number {\n  return PLAN_FEATURES[planType].maxDiscountPercent\n}\n\nexport function getMaxFileSizeInBytes(planType: PlanType): number {\n  return PLAN_FEATURES[planType].maxFileSize * 1024 * 1024 // Convert MB to bytes\n}\n\nexport function getMaxFileSizeMB(planType: PlanType): number {\n  return PLAN_FEATURES[planType].maxFileSize\n}\n\nexport function canUploadPack(\n  currentPlan: PlanType,\n  totalPacks: number,\n  packsThisMonth: number,\n): { canUpload: boolean; reason?: string } {\n  const features = PLAN_FEATURES[currentPlan]\n\n  if (features.maxTotalPacks !== null && totalPacks >= features.maxTotalPacks) {\n    return {\n      canUpload: false,\n      reason: `Has alcanzado el l칤mite de ${features.maxTotalPacks} packs totales del plan ${currentPlan.toUpperCase()}`,\n    }\n  }\n\n  if (features.maxPacksPerMonth !== null && packsThisMonth >= features.maxPacksPerMonth) {\n    return {\n      canUpload: false,\n      reason: `Has alcanzado el l칤mite de ${features.maxPacksPerMonth} packs por mes del plan ${currentPlan.toUpperCase()}`,\n    }\n  }\n\n  return { canUpload: true }\n}\n\nexport function canEditPack(currentPlan: PlanType, packCreatedAt: Date): { canEdit: boolean; reason?: string } {\n  const features = PLAN_FEATURES[currentPlan]\n\n  if (features.canEditAfterDays === null) {\n    return { canEdit: true }\n  }\n\n  const daysSinceCreation = Math.floor((Date.now() - packCreatedAt.getTime()) / (1000 * 60 * 60 * 24))\n\n  if (daysSinceCreation > features.canEditAfterDays) {\n    return {\n      canEdit: false,\n      reason: `El plan ${currentPlan.toUpperCase()} solo permite editar packs durante los primeros ${features.canEditAfterDays} d칤as`,\n    }\n  }\n\n  return { canEdit: true }\n}\n\nexport function getPlanCommission(planType: PlanType): number {\n  return PLAN_FEATURES[planType].commission\n}\n\nexport function getPlanMaxPrice(planType: PlanType): number | null {\n  return PLAN_FEATURES[planType].maxPrice\n}\n\nexport function getMaxFreeDownloads(planType: PlanType): number | null {\n  return PLAN_FEATURES[planType].maxFreeDownloads\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 335, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/benii/Downloads/ARSOUND%20-%20DEMO%20WEB/app/api/packs/upload/route.ts"],"sourcesContent":["import { createServerClient } from \"@/lib/supabase/server-client\"\nimport { getUserPlan } from \"@/lib/plans-actions\"\nimport { PLAN_FEATURES, type PlanType } from \"@/lib/plans\"\nimport { NextResponse } from \"next/server\"\n\nexport async function POST(request: Request) {\n  try {\n    const supabase = await createServerClient()\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser()\n\n    if (!user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const {\n      title,\n      description,\n      genre,\n      bpm,\n      price,\n      tags,\n      cover_image_url,\n      demo_audio_url,\n      file_url,\n      has_discount,\n      discount_percent,\n      discountCode,\n      discountType,\n    } = body\n\n    console.log(\"[v0] Upload request received:\", {\n      title,\n      user_id: user.id,\n      price,\n    })\n\n    if (!title || !description || !genre || price === undefined || !file_url) {\n      const missingFields = []\n      if (!title) missingFields.push(\"title\")\n      if (!description) missingFields.push(\"description\")\n      if (!genre) missingFields.push(\"genre\")\n      if (price === undefined) missingFields.push(\"price\")\n      if (!file_url) missingFields.push(\"file_url\")\n\n      return NextResponse.json(\n        {\n          error: \"Validation failed\",\n          details: `Missing required fields: ${missingFields.join(\", \")}`,\n          missingFields,\n        },\n        { status: 400 }\n      )\n    }\n\n    if (!file_url.startsWith(\"https://\")) {\n      return NextResponse.json(\n        {\n          error: \"Invalid file URL\",\n          details: \"file_url must be a full HTTPS URL from Supabase Storage\",\n        },\n        { status: 400 }\n      )\n    }\n\n    // Get user plan\n    const { plan, error: planError } = await getUserPlan(user.id)\n\n    if (planError) {\n      console.error(\"[v0] Error getting user plan:\", planError)\n      return NextResponse.json(\n        {\n          error: \"Could not verify user plan\",\n          details: planError,\n        },\n        { status: 500 }\n      )\n    }\n\n    console.log(\"User plan:\", plan)\n\n    const planLimits = PLAN_FEATURES[plan as PlanType]\n    const priceNum = Number.parseInt(price)\n    \n    if (priceNum > 0) {\n      const { data: profile, error: profileError } = await supabase\n        .from(\"profiles\")\n        .select(\"mp_connected\")\n        .eq(\"id\", user.id)\n        .single()\n\n      if (profileError || !profile?.mp_connected) {\n        return NextResponse.json(\n          {\n            error: \"Mercado Pago not connected\",\n            details: \"Necesit치s conectar tu cuenta de Mercado Pago para vender packs. And치 a tu perfil para conectarla.\",\n          },\n          { status: 403 }\n        )\n      }\n    }\n\n    if (plan === \"free\") {\n      // FREE plan: check TOTAL packs limit (3 total)\n      const { data: totalPacks, error: totalError } = await supabase.rpc(\"count_total_packs\", {\n        p_user_id: user.id,\n      })\n\n      console.log(\"[v0] FREE plan - Total packs:\", totalPacks, \"/ Limit:\", planLimits.maxTotalPacks)\n\n      if (totalError) {\n        console.error(\"[v0] Error checking total packs:\", totalError)\n        return NextResponse.json(\n          {\n            error: \"Could not verify upload limit\",\n            details: \"Failed to check your upload quota\",\n          },\n          { status: 500 }\n        )\n      }\n\n      if (planLimits.maxTotalPacks !== null && (totalPacks || 0) >= planLimits.maxTotalPacks) {\n        console.log(\"[v0] Upload blocked: FREE plan limit reached\")\n        return NextResponse.json(\n          {\n            error: \"Upload limit reached\",\n            details: `Alcanzaste tu l칤mite de ${planLimits.maxTotalPacks} packs totales en el plan FREE. Mejor치 tu plan para subir m치s.`,\n            current: totalPacks,\n            limit: planLimits.maxTotalPacks,\n          },\n          { status: 403 }\n        )\n      }\n      \n      console.log(\"[v0] FREE plan validation passed\")\n    } else if (plan === \"de_0_a_hit\") {\n      // DE_0_A_HIT plan: check MONTHLY packs limit (10 per month)\n      const { data: packsThisMonth, error: statsError } = await supabase.rpc(\"count_packs_this_month\", {\n        p_user_id: user.id,\n      })\n\n      console.log(\"[v0] DE_0_A_HIT plan - Packs this month:\", packsThisMonth, \"/ Limit:\", planLimits.maxPacksPerMonth)\n\n      if (statsError) {\n        console.error(\"[v0] Error checking monthly packs:\", statsError)\n        return NextResponse.json(\n          {\n            error: \"Could not verify upload limit\",\n            details: \"Failed to check your monthly upload quota\",\n          },\n          { status: 500 }\n        )\n      }\n\n      if (planLimits.maxPacksPerMonth !== null && (packsThisMonth || 0) >= planLimits.maxPacksPerMonth) {\n        console.log(\"[v0] Upload blocked: DE_0_A_HIT monthly limit reached\")\n        return NextResponse.json(\n          {\n            error: \"Upload limit reached\",\n            details: `Alcanzaste tu l칤mite de ${planLimits.maxPacksPerMonth} packs por mes en el plan De 0 a Hit. Esper치 al pr칩ximo mes o mejor치 tu plan.`,\n            current: packsThisMonth,\n            limit: planLimits.maxPacksPerMonth,\n          },\n          { status: 403 }\n        )\n      }\n      \n      console.log(\"[v0] DE_0_A_HIT plan validation passed\")\n    } else if (plan === \"studio_plus\") {\n      // STUDIO_PLUS: no limits\n      console.log(\"[v0] STUDIO_PLUS plan - no limits, validation passed\")\n    }\n\n    if (planLimits.maxPrice !== null && priceNum > planLimits.maxPrice) {\n      return NextResponse.json(\n        {\n          error: \"Price exceeds limit\",\n          details: `El precio m치ximo para tu plan ${plan} es $${planLimits.maxPrice.toLocaleString()} ARS.`,\n          current: priceNum,\n          limit: planLimits.maxPrice,\n        },\n        { status: 403 }\n      )\n    }\n\n    if (has_discount && discount_percent) {\n      const maxDiscount = planLimits.maxDiscountPercent\n      if (Number.parseInt(discount_percent) > maxDiscount) {\n        return NextResponse.json(\n          {\n            error: \"Discount exceeds limit\",\n            details: `Tu plan ${plan} permite m치ximo ${maxDiscount}% de descuento.`,\n            current: discount_percent,\n            limit: maxDiscount,\n          },\n          { status: 403 }\n        )\n      }\n    }\n\n    console.log(\"[v0] All validations passed, creating pack...\")\n\n    let packData: any = {\n      user_id: user.id,\n      title,\n      description,\n      genre,\n      bpm: bpm || null,\n      price: priceNum,\n      cover_image_url: cover_image_url || null,\n      demo_audio_url,\n      file_url,\n      tags: tags || [],\n      has_discount: has_discount || false,\n      discount_percent: has_discount ? Number.parseInt(discount_percent) : 0,\n    }\n\n    // Try with archived column first\n    let { data: pack, error: packError } = await supabase\n      .from(\"packs\")\n      .insert({ ...packData, archived: false })\n      .select()\n      .single()\n\n    // If archived column doesn't exist, try without it\n    if (packError && packError.code === '42703') {\n      console.log(\"[v0] Archived column doesn't exist yet, inserting without it\")\n      const result = await supabase\n        .from(\"packs\")\n        .insert(packData)\n        .select()\n        .single()\n      \n      pack = result.data\n      packError = result.error\n    }\n\n    if (packError) {\n      console.error(\"[v0] Error inserting pack:\", packError)\n      return NextResponse.json(\n        {\n          error: \"Failed to create pack\",\n          details: `Database error: ${packError.message}`,\n          code: packError.code,\n        },\n        { status: 500 }\n      )\n    }\n\n    console.log(\"[v0] Pack created successfully:\", pack?.id)\n\n    if (has_discount && discountCode && pack?.id) {\n      console.log(\"[v0] Creating discount code:\", {\n        code: discountCode,\n        pack_id: pack.id,\n        discount_percent: Number.parseInt(discount_percent),\n        type: discountType,\n      })\n\n      const { error: discountError } = await supabase.from(\"discount_codes\").insert({\n        pack_id: pack.id,\n        code: discountCode.toUpperCase(),\n        discount_percent: Number.parseInt(discount_percent),\n        for_all_users: discountType === \"all\",\n        for_first_purchase: discountType === \"first\",\n        for_followers: discountType === \"followers\",\n        max_uses: null,\n        expires_at: null,\n      })\n\n      if (discountError) {\n        console.error(\"[v0] Error creating discount code:\", discountError)\n      } else {\n        console.log(\"[v0] Discount code created successfully\")\n      }\n    }\n\n    const { error: updateError } = await supabase.rpc(\"increment\", {\n      table_name: \"profiles\",\n      row_id: user.id,\n      column_name: \"packs_count\",\n    })\n\n    if (updateError) {\n      console.error(\"[v0] Error updating packs_count:\", updateError)\n    }\n\n    console.log(\"[v0] Upload complete successfully!\")\n\n    return NextResponse.json({\n      success: true,\n      pack,\n      message: \"Pack uploaded successfully\",\n    })\n  } catch (error: any) {\n    console.error(\"[v0] Upload error:\", error)\n    return NextResponse.json(\n      {\n        error: \"Internal server error\",\n        details: error.message || \"An unexpected error occurred during upload\",\n      },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}