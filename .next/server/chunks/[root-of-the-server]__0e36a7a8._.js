module.exports=[18622,(e,r,t)=>{r.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,r,t)=>{r.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},54276,e=>{"use strict";e.s(["PLAN_FEATURES",0,{free:{maxPacksPerMonth:null,maxTotalPacks:3,maxPrice:15e3,maxFileSize:80,commission:.15,canUseDiscountCodes:!1,canAccessFullStats:!1,featuredPriority:0,canEditAfterDays:15,canPinPack:!1,canAddExternalLinks:!1,maxFreeDownloads:10,maxDiscountPercent:10},de_0_a_hit:{maxPacksPerMonth:10,maxTotalPacks:null,maxPrice:65e3,maxFileSize:250,commission:.1,canUseDiscountCodes:!0,canAccessFullStats:!0,featuredPriority:1,canEditAfterDays:null,canPinPack:!1,canAddExternalLinks:!1,maxFreeDownloads:null,maxDiscountPercent:50},studio_plus:{maxPacksPerMonth:null,maxTotalPacks:null,maxPrice:null,maxFileSize:500,commission:.03,canUseDiscountCodes:!0,canAccessFullStats:!0,featuredPriority:2,canEditAfterDays:null,canPinPack:!0,canAddExternalLinks:!0,maxFreeDownloads:null,maxDiscountPercent:100}}])},97953,(e,r,t)=>{"use strict";r.exports=e.r(42315).vendored["react-rsc"].ReactServerDOMTurbopackServer},45015,(e,r,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"registerServerReference",{enumerable:!0,get:function(){return a.registerServerReference}});let a=e.r(97953)},95975,(e,r,t)=>{"use strict";function a(e){for(let r=0;r<e.length;r++){let t=e[r];if("function"!=typeof t)throw Object.defineProperty(Error(`A "use server" file can only export async functions, found ${typeof t}.
Read more: https://nextjs.org/docs/messages/invalid-use-server-value`),"__NEXT_ERROR_CODE",{value:"E352",enumerable:!1,configurable:!0})}}Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"ensureServerEntryExports",{enumerable:!0,get:function(){return a}})},42868,e=>{"use strict";var r=e.i(47909),t=e.i(74017),a=e.i(96250),n=e.i(59756),s=e.i(61916),o=e.i(14444),i=e.i(37092),l=e.i(69741),c=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),m=e.i(66012),x=e.i(70101),f=e.i(26937),h=e.i(10372),v=e.i(93695);e.i(52474);var g=e.i(5232),R=e.i(59607),_=e.i(45015);async function P(e,r,t){try{let a=await (0,R.createServerClient)(),{error:n}=await a.from("user_plans").update({is_active:!1}).eq("user_id",e);if(n)return console.error("[v0] Error deactivating plans:",n),{success:!1,error:n.message};let{error:s}=await a.from("user_plans").insert({user_id:e,plan_type:r,is_active:!0,started_at:new Date().toISOString(),expires_at:t?t.toISOString():null});if(s)return console.error("[v0] Error inserting new plan:",s),{success:!1,error:s.message};return{success:!0}}catch(e){return console.error("[v0] Error updating user plan:",e),{success:!1,error:e.message||"Unknown error"}}}async function E(e){try{let r=await (0,R.createServerClient)(),{data:t,error:a}=await r.rpc("get_user_plan",{p_user_id:e});if(a)return console.error("[v0] Error fetching user plan:",a),{plan:"free",error:a.message};return{plan:t?.plan_type||"free"}}catch(e){return console.error("[v0] Error getting user plan:",e),{plan:"free",error:e.message||"Unknown error"}}}async function w(e){try{let r=await (0,R.createServerClient)(),{data:{user:t}}=await r.auth.getUser();if(!t)return{success:!1,error:"No authenticated user"};return await P(t.id,e,null)}catch(e){return{success:!1,error:e.message||"Unknown error"}}}(0,e.i(95975).ensureServerEntryExports)([P,E,w]),(0,_.registerServerReference)(P,"706c6089d8abe58dfe4529ac49b8610f4ccfe6d87c",null),(0,_.registerServerReference)(E,"406258943aac67d36e4364abc9baec35871a25b382",null),(0,_.registerServerReference)(w,"40c83a7e25e103ff414d04486e0506ab35f877dea4",null);var y=e.i(54276),k=e.i(89171);async function b(e){try{let r=await (0,R.createServerClient)(),{data:{user:t}}=await r.auth.getUser();if(!t)return k.NextResponse.json({error:"Unauthorized"},{status:401});let{title:a,description:n,genre:s,bpm:o,price:i,tags:l,cover_image_url:c,demo_audio_url:u,file_url:d,has_discount:p,discount_percent:m,discountCode:x,discountType:f}=await e.json();if(!a||!n||!s||void 0===i||!d){let e=[];return a||e.push("title"),n||e.push("description"),s||e.push("genre"),void 0===i&&e.push("price"),d||e.push("file_url"),k.NextResponse.json({error:"Validation failed",details:`Missing required fields: ${e.join(", ")}`,missingFields:e},{status:400})}if(!d.startsWith("https://"))return k.NextResponse.json({error:"Invalid file URL",details:"file_url must be a full HTTPS URL from Supabase Storage"},{status:400});let{plan:h,error:v}=await E(t.id);if(v)return k.NextResponse.json({error:"Could not verify user plan",details:v},{status:500});let g=y.PLAN_FEATURES[h],_=Number.parseInt(i);if(_>0){let{data:e,error:a}=await r.from("profiles").select("mp_connected").eq("id",t.id).single();if(a||!e?.mp_connected)return k.NextResponse.json({error:"Mercado Pago not connected",details:"Necesitás conectar tu cuenta de Mercado Pago para vender packs. Andá a tu perfil para conectarla."},{status:403})}let{data:P,error:w}=await r.rpc("count_total_packs",{p_user_id:t.id});if(w&&console.error("[v0] Error checking total packs:",w),"free"===h&&null!==g.maxTotalPacks&&(P||0)>=g.maxTotalPacks)return k.NextResponse.json({error:"Upload limit reached",details:`Alcanzaste tu l\xedmite de ${g.maxTotalPacks} packs totales en el plan FREE. Mejor\xe1 tu plan para subir m\xe1s.`,current:P,limit:g.maxTotalPacks},{status:403});let{data:b,error:S}=await r.rpc("count_packs_this_month",{p_user_id:t.id});if(S)return console.error("[v0] Error checking upload limit:",S),k.NextResponse.json({error:"Could not verify upload limit",details:"Failed to check your monthly upload quota"},{status:500});if("de_0_a_hit"===h&&null!==g.maxPacksPerMonth&&(b||0)>=g.maxPacksPerMonth)return k.NextResponse.json({error:"Upload limit reached",details:`Alcanzaste tu l\xedmite de ${g.maxPacksPerMonth} packs por mes en el plan De 0 a Hit. Esper\xe1 al pr\xf3ximo mes o mejor\xe1 tu plan.`,current:b,limit:g.maxPacksPerMonth},{status:403});if(null!==g.maxPrice&&_>g.maxPrice)return k.NextResponse.json({error:"Price exceeds limit",details:`El precio m\xe1ximo para tu plan ${h} es $${g.maxPrice.toLocaleString()} ARS.`,current:_,limit:g.maxPrice},{status:403});if(p&&m){let e=g.maxDiscountPercent;if(Number.parseInt(m)>e)return k.NextResponse.json({error:"Discount exceeds limit",details:`Tu plan ${h} permite m\xe1ximo ${e}% de descuento.`,current:m,limit:e},{status:403})}let{data:A,error:C}=await r.from("packs").insert({user_id:t.id,title:a,description:n,genre:s,bpm:o||null,price:_,cover_image_url:c||null,demo_audio_url:u,file_url:d,tags:l||[],has_discount:p||!1,discount_percent:p?Number.parseInt(m):0}).select().single();if(C)return console.error("[v0] Error inserting pack:",C),k.NextResponse.json({error:"Failed to create pack",details:`Database error: ${C.message}`,code:C.code},{status:500});if(p&&x&&A?.id){console.log("[v0] Creating discount code:",{code:x,pack_id:A.id,discount_percent:Number.parseInt(m),type:f});let{error:e}=await r.from("discount_codes").insert({pack_id:A.id,code:x.toUpperCase(),discount_percent:Number.parseInt(m),for_all_users:"all"===f,for_first_purchase:"first"===f,for_followers:"followers"===f,max_uses:null,expires_at:null});e?console.error("[v0] Error creating discount code:",e):console.log("[v0] Discount code created successfully")}let{error:N}=await r.rpc("increment",{table_name:"profiles",row_id:t.id,column_name:"packs_count"});return N&&console.error("[v0] Error updating packs_count:",N),k.NextResponse.json({success:!0,pack:A,message:"Pack uploaded successfully"})}catch(e){return console.error("[v0] Upload error:",e),k.NextResponse.json({error:"Internal server error",details:e.message||"An unexpected error occurred during upload"},{status:500})}}e.s(["POST",()=>b],32985);var S=e.i(32985);let A=new r.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/packs/upload/route",pathname:"/api/packs/upload",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/packs/upload/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:C,workUnitAsyncStorage:N,serverHooks:j}=A;function T(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:N})}async function D(e,r,a){A.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/packs/upload/route";R=R.replace(/\/index$/,"")||"/";let _=await A.prepare(e,r,{srcPage:R,multiZoneDraftMode:!1});if(!_)return r.statusCode=400,r.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:P,params:E,nextConfig:w,parsedUrl:y,isDraftMode:k,prerenderManifest:b,routerServerContext:S,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:j,clientReferenceManifest:T,serverActionsManifest:D}=_,U=(0,l.normalizeAppPath)(R),O=!!(b.dynamicRoutes[U]||b.routes[j]),M=async()=>((null==S?void 0:S.render404)?await S.render404(e,r,y,!1):r.end("This page could not be found"),null);if(O&&!k){let e=!!b.routes[j],r=b.dynamicRoutes[U];if(r&&!1===r.fallback&&!e){if(w.experimental.adapterPath)return await M();throw new v.NoFallbackError}}let q=null;!O||A.isDev||k||(q="/index"===(q=j)?"/":q);let I=!0===A.isDev||!O,F=O&&!I;D&&T&&(0,o.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:T,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let H=e.method||"GET",$=(0,s.getTracer)(),L=$.getActiveScopeSpan(),K={params:E,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:I,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,t,a)=>A.onRequestError(e,r,a,S)},sharedContext:{buildId:P}},z=new c.NodeNextRequest(e),B=new c.NodeNextResponse(r),V=u.NextRequestAdapter.fromNodeNextRequest(z,(0,u.signalFromNodeResponse)(r));try{let o=async e=>A.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let t=$.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=t.get("next.route");if(a){let r=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":r}),e.updateName(r)}else e.updateName(`${H} ${R}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var s,l;let c=async({previousCacheEntry:t})=>{try{if(!i&&C&&N&&!t)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let s=await o(n);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=K.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(z,B,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),r=(0,x.toNodeOutgoingHttpHeaders)(s.headers);c&&(r[h.NEXT_CACHE_TAGS_HEADER]=c),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let t=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:t,expire:a}}}}catch(r){throw(null==t?void 0:t.isStale)&&await A.onRequestError(e,r,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:C})},S),r}},u=await A.handleResponse({req:e,nextConfig:w,cacheKey:q,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:i});if(!O)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||r.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,x.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&O||d.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||r.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(z,B,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};L?await l(L):await $.withPropagatedContext(e.headers,()=>$.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(r){if(r instanceof v.NoFallbackError||await A.onRequestError(e,r,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:C})}),O)throw r;return await (0,m.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>T,"routeModule",()=>A,"serverHooks",()=>j,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>N],42868)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__0e36a7a8._.js.map